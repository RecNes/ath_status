{% load i18n static %}
<!DOCTYPE html>
<html lang="tr" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>All Times High Rates</title>
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">

    <style>
        a {
            color: #e9f3ffff;
            text-decoration: underline;
            transition: color 0.2s;
        }
        a:hover {
            color: #b8d6ffff;
        }
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300&display=swap');

        body {
            background-color: #e3eafc;
            font-family: 'Open Sans', sans-serif;
        }

        .container {
            width: 100%;
            background-color: #e3eafc;
            display: flex;
            justify-content: center;
        }

        .centered {
            width: 1280px;
            height: 720px;
            background-color: #3a5fc8;
            border-radius: 30px;
            padding: 10px;
            box-shadow: 0 4px 24px 0 #b6c6e6;
        }
        .inner-left {
            background-color: #f7faff;
            width: 70%;
            height: 100%;
            border-radius: 25px;
            display: flex;
            justify-content: center;
            float: left;
        }
        .inner-right {
            background-color: #3a5fc8;
            width: 29%;
            height: 100%;
            border-radius: 25px;
            display: flex;
            justify-content: center;
            float: right;
        }
        .box_left {
            margin: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .box_right {
            width: 100%;
        }
        .box_right h2 {
            color: #ffffff;
            text-align: center;
            background-color: #4b6ed6;
            height: 60px;
            border-radius: 25px;
            margin-top: 10px;
            box-shadow: 0 2px 12px 0 #b6c6e6;
        }
        .box_right h2 span {
             padding-top: 5px;
        }
        .box_left table thead tr td {
            border: #b6c6e6 1px solid;
            background-color: #e3eafc;
            border-radius: 30px;
            color: #3a5fc8;
            padding-left: 5px;
            padding-right: 5px;
        }
        .box_left table tbody tr td {
            color: #2d3e5e;
        }
        .box_left table {
            background-color: #f7faff;
        }
        /* color scheme: logo blue #3a5fc8, accent #4b6ed6, background #e3eafc, white #f7faff, shadow #b6c6e6, text #2d3e5e */

    </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>

    <script type="text/javascript">
        function getCookie(name) {
            if (!document.cookie) {
                return null;
            }

            const xsrfCookies = document.cookie.split(';')
                .map(c => c.trim())
                .filter(c => c.startsWith(name + '='));

            if (xsrfCookies.length === 0) {
                return null;
            }
                return decodeURIComponent(xsrfCookies[0].split('=')[1]);
            }

        const csrfToken = getCookie('CSRF-TOKEN');

        function getXValues(data) {
            var dateList = [];
            data.forEach(item => {
                // Format as YYYY-MM-DD for 30-day axis
                let d = new Date(item.record_date);
                let formatted = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                dateList.push(formatted);
            });
            return dateList;
        }

        function getYValues(data) {
            var rateList = [];
            data.forEach( item => {
                rateList.push(Number(item.exchange_rate));
            })
            return rateList;
        }

        function drawCharts() {
            fetch('/get-all-chart-data/')
                .then(response => response.json())
                .then(allData => {
                    let chartCanvases = document.getElementsByClassName('currency-chart');
                    Array.prototype.forEach.call(chartCanvases, function(item) {
                        let id = item.dataset.id;
                        let data = allData[id] || [];
                        let xValues = getXValues(data);
                        let yValues = getYValues(data);
                        let chart = new Chart(item, {
                            type: 'line',
                            data: {
                                labels: xValues,
                                datasets: [{
                                    data: yValues,
                                    borderColor: '#3a5fc8',
                                    backgroundColor: 'rgba(58,95,200,0.08)',
                                    pointRadius: 2,
                                    lineTension: 0.2
                                }]
                            },
                            options: {
                                legend: {
                                    display: false
                                },
                                scales: {
                                    xAxes: [{
                                        type: 'category',
                                        ticks: {
                                            autoSkip: true,
                                            maxTicksLimit: 30,
                                            fontColor: '#2d3e5e',
                                            fontSize: 10
                                        },
                                        gridLines: {
                                            display: false
                                        }
                                    }],
                                    yAxes: [{
                                        ticks: {
                                            fontColor: '#2d3e5e',
                                            fontSize: 10
                                        },
                                        gridLines: {
                                            color: '#e3eafc'
                                        }
                                    }]
                                },
                                tooltips: {
                                    callbacks: {
                                        title: function(tooltipItems, data) {
                                            return 'GÃ¼n: ' + tooltipItems[0].label;
                                        },
                                        label: function(tooltipItem, data) {
                                            return 'ATH: ' + tooltipItem.value;
                                        }
                                    }
                                }
                            }
                        });
                        chart.update();
                    });
                });
        }
    </script>
</head>
<body onload="drawCharts();">

<div class="container">
    <div class="centered">
        <div class="inner-left">
            <div class="box_left">

                <table style="border: black 0 solid; align-self: center; width: 98%; text-align: center;">
                    <thead>
                    <tr>
                        <td>{% trans "Currency" %}</td>
                        <td>{% trans "Current Rate" %}</td>
                        <td>{% trans "ATH Rate" %}</td>
                        <td>{% trans "One Unit Dropped" %}</td>
                        <td>{{ graph_day_range }} {% trans " Days Graph" %}</td>
                    </tr>
                    </thead>
                    <tbody>
                    {% for exchange_currency in exchange_currencies %}
                    <tr>
                        <td>
                            1 {{ exchange_currency.base.upper }}
                            {% if exchange_currency.base_symbol %}
                            ({{ exchange_currency.base_symbol }})
                            {% endif %}
                        </td>
                        <td title="{{ exchange_currency.rates.last.record_date }}">
                            {{ exchange_currency.rates.last.exchange_rate }}
                            {% if exchange_currency.target_symbol %}
                            {{ exchange_currency.target_symbol }}
                            {% endif %}
                        </td>
                        <td title="{{ exchange_currency.alltimehigh.update_date }}">
                            {{ exchange_currency.alltimehigh.exchange_rate }}
                            {% if exchange_currency.target_symbol %}
                            {{ exchange_currency.target_symbol }}
                            {% endif %}
                        </td>
                        <td title="{{ exchange_currency.oneunitdropped.update_date }}">
                            {{ exchange_currency.oneunitdropped.exchange_rate }}
                            {% if exchange_currency.target_symbol %}
                            {{ exchange_currency.target_symbol }}
                            {% endif %}
                        </td>
                        <td>
                            <canvas class="currency-chart" id="{{ exchange_currency.id }}-currency-chart"
                                    data-id="{{ exchange_currency.id }}" width="300" height="50">
                            </canvas>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="inner-right">
            <div class="box_right" style="padding: 0 10px; color: white;">
                <h2>
                    <span style="display: flex; align-items: center; justify-content: center; gap: 5px;">
                        <span>ALL TIMES HIGH RATES</span>
                        <span>
                            <img src="{% static 'logo.png' %}" alt="Logo" style="height: 40px; vertical-align: middle; border-radius: 8px; margin-left: 10px;">
                        </span>
                    </span>
                </h2>
                <p style="width: 300px; margin-left: auto; margin-right: auto;">
                    <span>
                        Collects ATH exchange rates, and then tweets and/or send message over telegram if last ATH were exceeded.
                    </span>
                    <br>
                    <br>
                    <span>You can follow ATH messages from:</span>
                    <br>
                </p>
                <ul>
                    <li>
                        Via tweets at my personal <a href="https://twitter.com/Sencer_H" target="_blank">twitter
                        account</a>
                    </li>
                    <li>
                        Via Telegram messages of <a href="https://t.me/usdtryath_bot">@usdtryath_bot</a>
                    </li>
                </ul>

                <p style="width: 300px; margin-left: auto; margin-right: auto;">
                    You can checkout code base from <a href="https://github.com/RecNes/ath_status">GitHub</a> and give a
                    star if you like it.
                </p>
            </div>
        </div>
    </div>
</div>
</body>
</html>